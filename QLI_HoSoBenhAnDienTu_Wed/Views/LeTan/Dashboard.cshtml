@model IEnumerable<QLI_HoSoBenhAnDienTu_Wed.Models.v_LichHenChoLeTan>
@{ ViewBag.Title = "Lễ tân - Duyệt lịch"; Layout = "~/Views/Shared/_Layout.cshtml"; }

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-primary fw-bold"><i class="fa-solid fa-clipboard-list"></i> Danh Sách Chờ Duyệt</h3>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary">
                <tr>
                    <th class="ps-4">Bệnh nhân</th>
                    <th>Liên hệ</th>
                    <th>Lý do khám</th>
                    <th>Giờ hẹn</th>
                    <th class="text-end pe-4">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="ps-4 fw-bold text-primary">@item.TenBenhNhan</td>
                        <td>
                            <div><i class="fa-solid fa-phone text-muted small me-1"></i>@item.SDT_LienHe</div>
                        </td>
                        <td>
                            <span class="text-danger fw-medium">@item.ly_do_kham</span>
                        </td>
                        <td>
                            <span class="badge bg-info text-dark">
                                @string.Format("{0:dd/MM HH:mm}", item.thoi_gian_hen)
                            </span>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-success px-3 me-1"
                                    onclick="openDuyetModal('@item.ma_lich_hen', '@item.TenBenhNhan', '@item.ly_do_kham')">
                                <i class="fa-solid fa-check"></i> Duyệt
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="xuLyHuy('@item.ma_lich_hen')">
                                <i class="fa-solid fa-xmark"></i> Hủy
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalDuyetLich" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fa-solid fa-user-doctor"></i> Phân Bổ Bác Sĩ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hiddenMaLichHen" />

                <div class="mb-3">
                    <label class="fw-bold text-muted small">Bệnh nhân:</label>
                    <h5 id="lblTenBenhNhan" class="text-dark fw-bold">Nguyen Van A</h5>
                </div>

                <div class="alert alert-warning d-flex align-items-start">
                    <i class="fa-solid fa-triangle-exclamation mt-1 me-2"></i>
                    <div>
                        <strong>Triệu chứng/Lý do:</strong>
                        <div id="lblLyDo" class="fst-italic">Đau bụng...</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">1. Chọn Chuyên Khoa phù hợp:</label>
                    @Html.DropDownList("ddlKhoa", (SelectList)ViewBag.ListKhoa, "-- Chọn Khoa --", new { @class = "form-select", @id = "ddlKhoa" })
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">2. Chỉ định Bác sĩ:</label>
                    <select id="ddlBacSi" class="form-select" disabled>
                        <option value="">-- Vui lòng chọn Khoa trước --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success fw-bold" onclick="submitDuyet()">
                    <i class="fa-solid fa-paper-plane"></i> Xác nhận & Duyệt
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function openDuyetModal(id, ten, lydo) {
            $('#hiddenMaLichHen').val(id);
            $('#lblTenBenhNhan').text(ten);
            $('#lblLyDo').text(lydo);

            $('#ddlKhoa').val('');
            $('#ddlBacSi').html('<option value="">-- Vui lòng chọn Khoa trước --</option>').prop('disabled', true);

            $('#modalDuyetLich').modal('show');
        }

        $('#ddlKhoa').change(function () {
            var maKhoa = $(this).val();
            if (!maKhoa) {
                $('#ddlBacSi').prop('disabled', true);
                return;
            }

            $.get('/LeTan/GetBacSiByKhoa', { maKhoa: maKhoa }, function (res) {
                var html = '<option value="">-- Chọn Bác sĩ --</option>';
                if (res.success) {
                    $.each(res.data, function (i, item) {
                        html += '<option value="' + item.ma_bac_si + '">' + item.ho_ten + '</option>';
                    });
                    $('#ddlBacSi').html(html).prop('disabled', false);
                }
            });
        });

        function submitDuyet() {
            var id = $('#hiddenMaLichHen').val();
            var bs = $('#ddlBacSi').val();

            if (!bs) {
                alert("Vui lòng chọn Bác sĩ để phân bổ!");
                return;
            }

            $.post("/LeTan/XuLyLich", { maLichHen: id, hanhDong: 'DUYET', maBacSi: bs }, function (res) {
                if (res.success) {
                    location.reload();
                } else {
                    alert("Lỗi: " + res.message);
                }
            });
        }

        function xuLyHuy(id) {
            if (!confirm('Bạn có chắc chắn muốn HỦY lịch hẹn này?')) return;

            $.post("/LeTan/XuLyLich", { maLichHen: id, hanhDong: 'HUY', maBacSi: null }, function (res) {
                if (res.success) location.reload();
                else alert("Lỗi: " + res.message);
            });
        }
    </script>
}